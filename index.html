<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤é»çµ±è¨ˆç¶œåˆç®¡ç†ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        /* --- å…¨åŸŸå°è¦½æ¨£å¼ (ä¿®æ”¹ç‚ºæµ®å‹•æ¨£å¼) --- */
        .app-nav {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 9999;
        }
        .nav-btn {
            padding: 12px 20px;
            background: #455A64;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            white-space: nowrap;
            text-align: center;
        }
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        .nav-btn.active {
            background: #7A918D;
            color: white;
            font-weight: bold;
            border: 2px solid white;
        }
        .page-container {
            display: none;
        }
        .page-container.active {
            display: block;
        }

        /* --- ç¶²é ä¸€ï¼šæœˆçµçµ±è¨ˆ CSS (åŸå§‹ä¿ç•™) --- */
        #page1 { font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif; background: #F2F0EB; padding: 20px; letter-spacing: 0.05em; padding-bottom: 100px; }
        #page1 .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        #page1 h1 { text-align: center; color: #455A64; font-weight: normal; margin-bottom: 30px; }
        #page1 .control-panel { display: flex; gap: 20px; background: #E8E6E1; padding: 20px; border-radius: 8px; margin-bottom: 25px; align-items: center; color: #444; }
        #page1 .main-content { display: grid; grid-template-columns: 1.2fr 2fr; gap: 25px; }
        #page1 .section { border: 1px solid #EBEBEB; border-radius: 8px; padding: 20px; background: #fff; display: flex; flex-direction: column; margin-bottom: 25px; }
        #page1 h3 { border-bottom: 2px solid #F0F0F0; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #444; font-size: 1.1rem; font-weight: 600; }
        #page1 .scroll-area { overflow-y: auto; border: 1px solid #F5F5F5; border-radius: 4px; max-height: 400px; }
        #page1 table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #page1 th, #page1 td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #F0F0F0; }
        #page1 #summaryTable th:nth-child(2), #page1 #summaryTable td:nth-child(2), #page1 #dailyTable th:nth-child(2), #page1 #dailyTable td:nth-child(2) { text-align: right; }
        #page1 th { background-color: #E0E5DF; color: #333; position: sticky; top: 0; z-index: 10; font-weight: 700; }
        #page1 .excluded-header-row { background-color: #F7F7F7; color: #777; font-size: 13px; text-align: center; padding: 8px; }
        #page1 .excluded-row { background-color: #FCFCFC; color: #AAA; }
        #page1 .name-cell { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        #page1 .btn { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; color: white; font-size: 13px; display: none; }
        #page1 #copyBtn { background-color: #7A918D; }
        #page1 #copyImgBtn { background-color: #6B7C8A; }
        #page1 .btn-group { display: flex; gap: 10px; }
        #page1 .price-input { width: 70px; text-align: right; border: 1px solid #DDD; border-radius: 4px; padding: 5px; color: #B05B5B; }
        #page1.capturing .price-input { display: none !important; }
        #page1.capturing .price-text { display: inline !important; font-weight: bold; color: #B05B5B; }
        .diff-warning { color: #d93025; font-size: 12px; margin-right: 4px; vertical-align: middle; cursor: help; }

        /* --- ç¶²é äºŒï¼šæ¯æ—¥é‡‘é¡ CSS (åŸå§‹ä¿ç•™) --- */
        #page2 { background-color: #fdfbf7; font-family: 'Noto Sans TC', sans-serif; color: #57534e; padding: 20px; padding-bottom: 100px; }
        #page2 .journal-box { background: #fff; border: 1px solid #e7e5e4; border-radius: 6px; }

        /* --- ç¶²é ä¸‰ï¼šçµ±è¨ˆåŠ©æ‰‹ CSS (æ›¿æ›ç‚ºæ–‡é’å„ªåŒ–ç‰ˆ) --- */
        :root {
            --primary-color: #8e9775;    /* è‹”è˜šç¶  */
            --primary-hover: #6d775c;
            --success-color: #a7adba;    /* éœ§éœ¾è— */
            --success-hover: #828a9b;
            --danger-color: #c97d60;     /* é™¶åœŸè‰² */
            --gray-color: #bdc3c7;
            --gray-hover: #95a5a6;
            --bg-color-p3: #faf9f6;      /* ç‡•éº¥è‰²èƒŒæ™¯ */
            --card-bg-p3: #ffffff;
            --text-color-p3: #4a4a4a;    /* æ·±ç°è¤ */
            --border-color-p3: #e8e8e8;
            --hint-bg-p3: #f2f2f2;
            --hint-border-p3: #e0e0e0;
            --hint-text-p3: #7f8c8d;
        }

        #page3 {
            background-color: var(--bg-color-p3);
            font-family: "PingFang TC", "STHeitiTC-Light", "Microsoft JhengHei", sans-serif;
            color: var(--text-color-p3);
            padding: 20px;
            padding-bottom: 100px;
            min-height: 100vh;
            letter-spacing: 0.05em;
        }
        #page3 .container {
            background: var(--card-bg-p3);
            padding: 30px 25px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.03);
            max-width: 488px;
            margin: 20px auto;
        }
        #page3 h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 500;
            color: #5d6146;
        }
        #page3 .hint {
            background-color: var(--hint-bg-p3);
            border: 1px solid var(--hint-border-p3);
            color: var(--hint-text-p3);
            font-size: 12px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            line-height: 1.8;
        }
        #page3 .hint span {
            display: block;
            position: relative;
            padding-left: 18px;
            margin-bottom: 4px;
        }
        #page3 .hint span::before {
            content: "â—¦";
            position: absolute;
            left: 0;
        }
        #page3 .mode-selector {
            display: flex;
            background: #f0f0f0;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        #page3 .mode-selector label {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        #page3 .mode-selector input { display: none; }
        #page3 .mode-selector input:checked + span {
            background: white;
            display: block;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-weight: bold;
            color: var(--primary-color);
        }
        #page3 textarea {
            width: 100%;
            height: 180px;
            padding: 15px;
            border: 1px solid var(--border-color-p3);
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 20px;
            box-sizing: border-box;
            resize: none;
            transition: all 0.3s;
            background-color: #fcfcfc;
            color: var(--text-color-p3);
        }
        #page3 textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #fff;
            box-shadow: 0 0 0 4px rgba(142, 151, 117, 0.1);
        }
        #page3 .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }
        #page3 button {
            flex: 1;
            min-width: 100px;
            padding: 12px 5px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            letter-spacing: 0.1em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        #page3 .process-btn { background-color: var(--primary-color); color: white; }
        #page3 .process-btn:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        #page3 .copy-btn { background-color: var(--success-color); color: white; }
        #page3 .copy-btn:hover { background-color: var(--success-hover); transform: translateY(-1px); }
        #page3 .clear-btn { background-color: transparent; color: var(--gray-hover); border: 1px solid #eee; }
        #page3 .clear-btn:hover { background-color: #f9f9f9; color: var(--danger-color); border-color: var(--danger-color); }
        #page3 .table-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 12px;
        }
        #page3 .reset-btn {
            background-color: #fcfcfc;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            font-size: 12px;
            padding: 6px 16px;
            min-width: auto;
            border-radius: 20px;
            letter-spacing: 0.05em;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #page3 .reset-btn:hover {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(142, 151, 117, 0.2);
            transform: translateY(-1px);
        }
        #page3 #resultArea { margin-top: 30px; display: none; animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #page3 #resultTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            background: #fff;
            font-size: 14px;
        }
        #page3 #resultTable th {
            background-color: transparent;
            color: #999;
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-weight: normal;
            text-transform: uppercase;
            font-size: 12px;
        }
        #page3 #resultTable td {
            padding: 15px 12px;
            border-bottom: 1px solid #f8f8f8;
            color: var(--text-color-p3);
            cursor: grab;
        }
        #page3 #resultTable th:first-child, #page3 #resultTable td:first-child { text-align: center; width: 40px; }
        #page3 #resultTable th:nth-child(2), #page3 #resultTable td:nth-child(2) { text-align: left; }
        #page3 #resultTable th:last-child, #page3 #resultTable td:last-child { text-align: center; width: 60px; }

        #page3 .check-cell { cursor: pointer !important; font-size: 18px; user-select: none; color: #ddd; }
        #page3 .row-checked { color: #ccc !important; }
        #page3 .row-checked td { color: #ccc !important; }
        #page3 .row-checked .check-cell { color: var(--primary-color); }
        #page3 .row-checked td:nth-child(2) { text-decoration: line-through; opacity: 0.6; }
        #page3 .dragging { opacity: 0.4; }
        #page3 .drop-merge { background-color: #faf9f0 !important; outline: 1px dashed var(--primary-color); }
        #page3 .drop-before { border-top: 2px solid var(--primary-color) !important; }
        #page3 .drop-after { border-bottom: 2px solid var(--primary-color) !important; }

        #page3 .summary-box {
            background: #fdfdfd;
            border-top: 1px solid #eee;
            padding: 20px 10px;
        }
        #page3 .summary-line {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 8px;
            color: #888;
        }
        #page3 .total-price { color: var(--danger-color); font-size: 22px; font-weight: 300; }
        #page3 .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        #page3 .modal-content {
            background: white;
            padding: 35px;
            border-radius: 20px;
            width: 85%;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        }
        #page3 .modal-input {
            width: 90%;
            padding: 10px;
            margin-bottom: 20px;
            border: none;
            border-bottom: 2px solid var(--primary-color);
            font-size: 20px;
            text-align: center;
            outline: none;
        }
        #page3 .modal-btns { display: flex; gap: 10px; }
        #page3 .msg-box {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(74, 74, 74, 0.9);
            color: white;
            padding: 12px 25px;
            border-radius: 12px;
            display: none;
            z-index: 3000;
            font-size: 13px;
            letter-spacing: 0.1em;
        }
        #page3 .star-mark {
            color: var(--danger-color);
            margin-left: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <nav class="app-nav">
        <button class="nav-btn active" onclick="switchPage(1)">1. æœˆçµçµ±è¨ˆ</button>
        <button class="nav-btn" onclick="switchPage(2)">2. æ¯æ—¥é‡‘é¡</button>
        <button class="nav-btn" onclick="switchPage(3)">3. çµ±è¨ˆåŠ©æ‰‹</button>
    </nav>

    <div id="page1" class="page-container active">
        <div class="container">
            <h1>æœˆçµé¤é»è²»ç”¨çµ±è¨ˆ</h1>
            <div class="control-panel">
                <div>1. ä¸Šå‚³æª”æ¡ˆï¼š<input type="file" id="fileInput" accept=".txt"></div>
                <div>2. é¸æ“‡æœˆä»½ï¼š<select id="monthSelect"></select></div>
                <div style="margin-left:auto;"><button onclick="clearAllData()" style="font-size: 11px; background: none; border: 1px solid #ccc; color: #999; cursor: pointer; border-radius: 4px; padding: 2px 8px;">æ‰‹å‹•æ¸…é™¤æ‰€æœ‰ç·©å­˜</button></div>
            </div>
            <div class="main-content">
                <div class="left-column">
                    <div class="section">
                        <h3><span>äººå“¡è²»ç”¨ç¸½è¨ˆ</span><span id="grandTotalDisplay" style="color: #5D4037;">0</span></h3>
                        <div class="scroll-area" id="summaryScrollArea">
                            <table id="summaryTable">
                                <thead><tr><th style="width:70%">å§“å</th><th style="width:30%">é‡‘é¡</th></tr></thead>
                                <tbody id="includedBody"></tbody>
                                <tbody><tr class="excluded-header-row"><td colspan="2">â–¼ æ’é™¤ä¸è¨ˆå€åŸŸ (ä¸åˆ—å…¥ç¸½é¡)</td></tr></tbody>
                                <tbody id="excludedBody" class="excluded-row"></tbody>
                            </table>
                        </div>
                        <div id="nonMonthlyList" class="non-monthly-box" style="display:none;"></div>
                    </div>
                    <div class="section">
                        <h3><span>æ¯æ—¥çµç®—ç¸½é¡</span><span id="dailyGrandTotalDisplay" style="color: #5D4037;">0</span></h3>
                        <div class="scroll-area"><table id="dailyTable"><thead><tr><th style="width:60%">æ—¥æœŸ</th><th style="width:40%">ç•¶æ—¥ç¸½é¡</th></tr></thead><tbody id="dailyBody"></tbody></table></div>
                    </div>
                </div>
                <div class="section" style="min-height: 600px;">
                    <h3><div>å€‹äººæ˜ç´°ï¼š<span id="selectedPersonName">-</span></div><div class="btn-group"><button id="copyBtn" class="btn">ğŸ“‹ è¤‡è£½æ–‡å­—</button><button id="copyImgBtn" class="btn">ğŸ–¼ï¸ è¤‡è£½åœ–ç‰‡</button></div></h3>
                    <div id="captureArea" style="background: white; padding: 15px; border-radius: 6px;">
                        <h4 id="imgTitle" style="margin: 0 0 15px 0; display:none; border-bottom: 2px solid #8FA39D; padding-bottom: 8px; font-size: 18px; color: #333;"></h4>
                        <div id="personalDetail"></div>
                        <div id="imgFooter" style="display:none; margin-top:25px; padding:15px; background-color:#F4F7F6; border-radius:8px; border:1px solid #E0EAE8;">
                            <div style="transform: translateY(-5px); font-size:13px; color:#546E7A; line-height:1.6;">
                                <div style="font-weight:bold; color:#455A64; margin-bottom:4px;">2æœˆçš„åˆé¤éŒ¢~Line payæˆ–æ˜¯åŒ¯æ¬¾éƒ½å¯ä»¥~</div>
                                <div style="margin-bottom:10px;">(ä¸è¦ipass money)</div>
                                <div style="font-size:11px; color:#90A4AE; letter-spacing:0.1em; border-top:1px solid #DCE6E5; padding-top:8px;">â†“åŒ¯æ¬¾å¸³è™Ÿâ†“</div>
                                <div style="font-family:monospace; font-size:14px; color:#37474F;">äº¬åŸéŠ€è¡Œ ç¸½è¡Œç‡Ÿæ¥­éƒ¨ (054)<br>001280705711</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="page2" class="page-container">
        <div class="max-w-md mx-auto py-10">
            <header class="mb-8 text-center"><h1 class="text-2xl font-normal tracking-[0.15em] text-stone-700 mb-3">ï¼æ¯æ—¥è¨‚é¤é‡‘é¡ç´€éŒ„ï¼</h1><div class="w-8 h-px bg-stone-300 mx-auto"></div></header>
            <div class="space-y-6">
                <section>
                    <label class="text-xs font-medium text-stone-400 mb-2 block">è¼¸å…¥è¨‚å–®å…§å®¹</label>
                    <textarea id="orderInput2" class="w-full h-44 p-4 journal-box outline-none resize-none text-sm text-stone-700 leading-relaxed" placeholder="è«‹åœ¨æ­¤è²¼ä¸Š..."></textarea>
                    <div class="flex gap-3 mt-3">
                        <button onclick="handleCalculate2()" class="flex-[2] bg-stone-600 text-white text-sm py-3 rounded shadow-sm">é–‹å§‹çµ±è¨ˆ</button>
                        <button onclick="handleClear2()" class="flex-1 border border-stone-300 text-stone-500 text-sm py-3 rounded hover:bg-stone-50">æ¸…ç©º</button>
                    </div>
                </section>
                <div id="resultArea2" class="hidden space-y-5">
                    <article class="journal-box p-6 relative bg-[#fffdfa]">
                        <div id="lunchResults2" class="space-y-2 text-base mb-5"></div>
                        <div id="drinkResults2" class="space-y-2 text-base"></div>
                        <div class="mt-6 pt-4 border-t border-dotted border-stone-300 space-y-2">
                            <div id="floor1Row2" class="hidden flex justify-between items-baseline text-stone-500"><span class="text-xs tracking-widest font-medium">1F åˆè¨ˆ</span><div class="text-lg font-light"><span id="floor1TotalDisplay2">0</span> å…ƒ</div></div>
                            <div class="flex justify-between items-baseline text-stone-500"><span class="text-xs tracking-widest font-medium">3F åˆè¨ˆ</span><div class="text-lg font-light"><span id="floor3TotalDisplay2">0</span> å…ƒ</div></div>
                            <div class="flex justify-between items-baseline pt-2 border-t border-stone-100"><span class="text-xs text-stone-400">ç¸½åˆè¨ˆ</span><div class="text-2xl font-light text-stone-800"><span id="grandTotal2">0</span> <span class="text-xs font-normal">å…ƒ</span></div></div>
                        </div>
                        <div class="flex gap-2 mt-5">
                            <button onclick="saveToHistory2()" class="flex-1 py-3 border border-stone-200 text-stone-600 text-xs rounded">è¨˜å…¥æ­·å²</button>
                            <button id="copyBtn2_real" onclick="handleCopy2()" class="flex-1 py-3 border border-stone-300 bg-stone-100 text-stone-600 text-xs rounded flex items-center justify-center gap-1">è¤‡è£½çµæœ</button>
                        </div>
                    </article>
                </div>
                <section class="pt-6 border-t border-stone-200">
                    <div class="flex justify-between items-end mb-4 px-1"><h3 class="text-xs font-medium text-stone-500">æ­·å²ç´€éŒ„</h3><select id="monthFilter2" onchange="renderHistory2()" class="bg-transparent text-xs text-stone-500 outline-none text-right"></select></div>
                    <div class="bg-stone-100 p-3 rounded mb-4 flex justify-between items-center border border-stone-200"><span class="text-xs text-stone-500">æœ¬æœˆç´¯è¨ˆ</span><span class="text-lg font-normal text-stone-700" id="monthTotalDisplay2">0 å…ƒ</span></div>
                    <div id="historyList2" class="space-y-2"></div>
                </section>
            </div>
        </div>
        <textarea id="hiddenCopyArea2" class="absolute -top-full opacity-0" readonly></textarea>
    </div>

    <div id="page3" class="page-container">
        <div id="toast" class="msg-box"></div>
        <div id="mainModal" class="modal">
            <div class="modal-content">
                <p id="modalMsg" style="margin-top: 0; font-size: 15px;">è¨Šæ¯å…§å®¹</p>
                <div id="priceInputArea" style="display: none;">
                    <p style="font-size: 12px; color: #999;">è«‹ç¢ºèªæˆ–ä¿®æ”¹åˆä½µå¾Œçš„å–®åƒ¹ï¼š</p>
                    <input type="number" id="customPrice" class="modal-input" placeholder="0">
                </div>
                <div class="modal-btns">
                    <button class="process-btn" id="modalYes">ç¢ºå®šåˆä½µ</button>
                    <button class="clear-btn" id="modalNo">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div class="container">
            <h2>â€” è¨‚å–®æ˜ç´°çµ±è¨ˆåŠ©æ‰‹ â€”</h2>
            <div class="hint">
                <span>æ ¼å¼ï¼šå§“å-é¤é» åƒ¹æ ¼ (æ”¯æ´ã€Œå…ƒã€å­—)</span>
                <span>ç›¸åŒåç¨±ä½†åƒ¹æ ¼ä¸åŒæ™‚æœƒæ¨™è¨» *</span>
                <span><b>æ‹–æ‹‰</b>å“é …å¯é€²è¡Œ <b>åˆä½µ</b> æˆ– <b>æ’åº</b></span>
            </div>
            <div class="mode-selector">
                <label><input type="radio" name="calcMode" value="split" checked><span>æ¨™æº–æ¨¡å¼</span></label>
                <label><input type="radio" name="calcMode" value="combo"><span>å¥—é¤æ¨¡å¼</span></label>
            </div>
            <textarea id="inputData" placeholder="åœ¨æ­¤è¼¸å…¥è¨‚å–®ç´°é …..."></textarea>
            <div class="btn-group">
                <button class="process-btn" onclick="processOrder()">é–‹å§‹çµ±è¨ˆ</button>
                <button class="copy-btn" onclick="copyResult()">è¤‡è£½çµæœ</button>
                <button class="clear-btn" onclick="clearContent()">æ¸…é™¤å…§å®¹</button>
            </div>
            <div id="resultArea">
                <div class="table-actions">
                    <button class="reset-btn" onclick="resetChecks()">âŸ² é‡è¨­æ‰€æœ‰å‹¾é¸</button>
                </div>
                <table id="resultTable">
                    <thead><tr><th>Status</th><th>Item Detail</th><th>Qty</th></tr></thead>
                    <tbody id="resultBody"></tbody>
                </table>
                <div class="summary-box">
                    <div class="summary-line"><span>ç¸½ä»½æ•¸</span><span id="totalQty">0 ä»½</span></div>
                    <div class="summary-line"><span>æ‡‰æ”¶ç¸½é‡‘é¡</span><span id="totalAmount" class="total-price">$0</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é€šç”¨åˆ‡æ›é‚è¼¯
        function switchPage(p) {
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('page'+p).classList.add('active');
            document.querySelectorAll('.nav-btn')[p-1].classList.add('active');
            if(p === 1) render();
        }

        // è¼”åŠ©å‡½å¼ï¼šæŒ‰éˆ•æ–‡å­—å›é¥‹
        function buttonFeedback(btn, originalText) {
            btn.textContent = "âœ… å·²è¤‡è£½ï¼";
            setTimeout(() => { btn.textContent = originalText; }, 1500);
        }

        // --- ç¶²é ä¸€ JS (æœˆçµçµ±è¨ˆ) ---
        let rawFileText = ""; let forceIncludeDates = new Set(); let excludedUsers = new Set();
        let personalStats = {}; let dailyStats = {}; let nonMonthlyDates = []; let currentSelectedUser = null;

        window.onload = function() { loadFromLocalStorage(); updateMonthSelector2(); renderHistory2(); };

        function saveToLocalStorage() {
            const data = { rawFileText, forceIncludeDates: Array.from(forceIncludeDates), excludedUsers: Array.from(excludedUsers), lastSelectedMonth: document.getElementById('monthSelect').value };
            localStorage.setItem('lunchStatsData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('lunchStatsData');
            if (saved) {
                const data = JSON.parse(saved);
                rawFileText = data.rawFileText || "";
                forceIncludeDates = new Set(data.forceIncludeDates || []);
                excludedUsers = new Set(data.excludedUsers || []);
                if (rawFileText) { updateMonthDropdown(data.lastSelectedMonth); render(); }
            }
        }

        function clearAllData(silent = false) {
            if(silent || confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ä¸¦é‡è¨­ç¶²é å—ï¼Ÿ")) {
                localStorage.removeItem('lunchStatsData');
                location.reload();
            }
        }

        function updateMonthDropdown(preSelected) {
            const matches = rawFileText.match(/\d{4}\.\d{2}\.\d{2}/g);
            if(matches) {
                const months = [...new Set(matches.map(d => d.substring(0, 7).replace(/\./g, '-')))].sort().reverse();
                const select = document.getElementById('monthSelect');
                select.innerHTML = months.map(m => `<option value="${m}">${m.replace(/-/g, '.')}æœˆ</option>`).join('');
                if (preSelected && months.includes(preSelected)) select.value = preSelected;
            }
        }

        function extractDayData(lines) {
            const dayData = {};
            lines.forEach(line => {
                let t = line.trim();
                if (!t || t.includes("$$æœˆçµ") || t.includes("çµå–®") || t === "---" || t === "åˆé¤" || t.includes("é£²æ–™")) return;
                const nameMatch = t.match(/^([^\d\s\-:ï¼š]{2,8})\s*[-:ï¼š]{1,2}(.*)$/);
                if (nameMatch) {
                    let name = nameMatch[1].trim().replace(/^\$/, ''); if (name === "å°è¨ˆ") return;
                    let content = nameMatch[2].trim();
                    if (!dayData[name]) dayData[name] = { total: 0, items: [], hasError: false };
                    let price = content.includes('=') ? parseInt(content.split('=').pop().match(/\d+/)) : parseInt(content.match(/\d+$/));
                    if (isNaN(price)) { dayData[name].hasError = true; dayData[name].items.push({ text: "âš ï¸ " + content, price: 0 }); }
                    else { dayData[name].total += price; dayData[name].items.push({ text: content, price: price }); }
                }
            });
            return dayData;
        }

        function parseLunchFile(text, targetMonth) {
            const lines = text.split(/\r?\n/); const result = {};
            const dateRegex = /^(\d{4}\.\d{2}\.\d{2})/; let datePositions = []; nonMonthlyDates = [];
            lines.forEach((line, idx) => { const m = line.match(dateRegex); if (m) datePositions.push({ idx, date: m[1].replace(/\./g, '-') }); });
            datePositions.forEach((pos, i) => {
                if (!pos.date.startsWith(targetMonth)) return;
                const nextIdx = datePositions[i+1] ? datePositions[i+1].idx : lines.length;
                const dayLines = lines.slice(pos.idx, nextIdx);
                if (dayLines.some(l => l.includes("$$æœˆçµ")) || forceIncludeDates.has(pos.date.replace(/-/g, '.'))) {
                    let lunchIdx = dayLines.findLastIndex(l => l.trim() === "åˆé¤");
                    if (lunchIdx !== -1) result[pos.date] = extractDayData(dayLines.slice(lunchIdx));
                } else nonMonthlyDates.push(pos.date.replace(/-/g, '.'));
            });
            return result;
        }

        document.getElementById('fileInput').addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = () => { rawFileText = reader.result; updateMonthDropdown(); render(); saveToLocalStorage(); };
            reader.readAsText(e.target.files[0]);
        });

        document.getElementById('monthSelect').addEventListener('change', () => { render(); saveToLocalStorage(); });

        function render() {
            const month = document.getElementById('monthSelect').value; if(!month) return;
            const data = parseLunchFile(rawFileText, month); personalStats = {}; dailyStats = {};
            for (let date in data) {
                if (!dailyStats[date]) dailyStats[date] = 0;
                for (let name in data[date]) {
                    if (!personalStats[name]) personalStats[name] = { total: 0, details: [], error: false };
                    personalStats[name].total += data[date][name].total; dailyStats[date] += data[date][name].total;
                    if (data[date][name].hasError) personalStats[name].error = true;
                    personalStats[name].details.push({ date, text: data[date][name].items.map(i=>i.text).join('ã€'), price: data[date][name].total });
                }
            }
            buildTable(); buildDailyTable(); renderNonMonthly();
        }

        function buildTable() {
            const inc = document.getElementById('includedBody'); const exc = document.getElementById('excludedBody');
            inc.innerHTML = ''; exc.innerHTML = ''; let grand = 0;
            Object.keys(personalStats).sort().forEach(name => {
                const isExc = excludedUsers.has(name); const stats = personalStats[name]; if (!isExc) grand += stats.total;
                const tr = document.createElement('tr'); if (isExc) tr.className = 'excluded-row';
                tr.innerHTML = `<td><div class="name-cell"><input type="checkbox" ${isExc?'':'checked'} onchange="toggleUser('${name}')"><span onclick="selectUser('${name}')">${name}${stats.error?'*':''}</span></div></td><td onclick="selectUser('${name}')" id="sum-${name}">${stats.total.toLocaleString()}</td>`;
                if (isExc) exc.appendChild(tr); else inc.appendChild(tr);
            });
            document.getElementById('grandTotalDisplay').textContent = grand.toLocaleString();
            document.getElementById('dailyGrandTotalDisplay').textContent = grand.toLocaleString();
        }

        function toggleUser(name) { if (excludedUsers.has(name)) excludedUsers.delete(name); else excludedUsers.add(name); buildTable(); saveToLocalStorage(); }
        function selectUser(name) { currentSelectedUser = name; updateDetail(name); }
        
        function buildDailyTable() {
            const body = document.getElementById('dailyBody'); body.innerHTML = '';
            const history = JSON.parse(localStorage.getItem('mealTracker_art_v2') || '[]');
            Object.keys(dailyStats).sort().forEach(d => {
                const displayDate = d.replace(/-/g,'/');
                const historyEntry = history.find(h => h.date === displayDate);
                const hasDiff = historyEntry && historyEntry.amount !== dailyStats[d];
                const warningTag = hasDiff ? `<span class="diff-warning" title="èˆ‡æ¯æ—¥é‡‘é¡ç´€éŒ„ä¸ç¬¦ (ç´€éŒ„ç‚º ${historyEntry.amount.toLocaleString()})">âš ï¸</span>` : '';
                body.innerHTML += `<tr><td>${displayDate}</td><td id="daily-sum-${d}" style="text-align:right;">${warningTag}${dailyStats[d].toLocaleString()}</td></tr>`;
            });
        }

        function updateDetail(name) {
            const stats = personalStats[name]; document.getElementById('selectedPersonName').textContent = name;
            document.getElementById('copyBtn').style.display = document.getElementById('copyImgBtn').style.display = 'inline-block';
            const box = document.getElementById('personalDetail');
            box.innerHTML = stats.details.sort((a,b)=>a.date.localeCompare(b.date)).map((d,i) => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee;">
                    <div style="flex:1; display:flex; align-items:center;">
                        <span style="font-size:14px; margin-top:-2px;">${d.date.substring(5).replace('-','/')}ï¼š${d.text}</span>
                    </div>
                    <input type="number" class="price-input" value="${d.price}" oninput="handlePriceChange('${name}', ${i}, this.value, this)">
                    <span class="price-text" style="display:none;">${d.price}</span>
                </div>
            `).join('') + `<div style="text-align:right; font-weight:bold; margin-top:10px;">ç¸½è¨ˆï¼š<span id="detail-total-${name}">${stats.total.toLocaleString()}</span></div>`;
        }

        function handlePriceChange(name, idx, val, el) {
            val = parseInt(val) || 0; const old = personalStats[name].details[idx].price; const date = personalStats[name].details[idx].date;
            personalStats[name].details[idx].price = val; personalStats[name].total += (val - old);
            dailyStats[date] += (val - old); buildTable(); buildDailyTable(); updateDetail(name);
        }

        function renderNonMonthly() {
            const el = document.getElementById('nonMonthlyList'); if (nonMonthlyDates.length > 0) {
                el.style.display = 'block'; el.innerHTML = `<strong>éæœˆçµæ—¥æœŸï¼š</strong><br>` + nonMonthlyDates.map(d => `<span onclick="forceIncludeDates.add('${d}');render();saveToLocalStorage();" style="cursor:pointer; text-decoration:underline; margin-right:8px;">${d}</span>`).join('');
            } else el.style.display = 'none';
        }

        document.getElementById('copyBtn').onclick = function() {
            const monthVal = document.getElementById('monthSelect').value;
            let monthStr = "XX"; if (monthVal) { const parts = monthVal.split('-'); monthStr = parseInt(parts[1], 10).toString(); }
            let txt = `${monthStr}æœˆçš„åˆé¤éŒ¢~Line payæˆ–æ˜¯åŒ¯æ¬¾éƒ½å¯å–”\n(ä¸è¦ipass money)\n\nâ†“åŒ¯æ¬¾å¸³è™Ÿâ†“\näº¬åŸéŠ€è¡Œ ç¸½è¡Œç‡Ÿæ¥­éƒ¨\n054\n001280705711`;
            navigator.clipboard.writeText(txt).then(() => { buttonFeedback(this, "ğŸ“‹ è¤‡è£½æ–‡å­—"); });
        };

        document.getElementById('copyImgBtn').onclick = function() {
            const area = document.getElementById('captureArea'); 
            const title = document.getElementById('imgTitle');
            const footer = document.getElementById('imgFooter');
            const btn = this;
            title.style.display = 'block'; 
            title.textContent = `ã€${currentSelectedUser} é¤è²»æ˜ç´°ã€‘`;
            footer.style.display = 'block'; 
            document.getElementById('page1').classList.add('capturing');
            html2canvas(area, { scale: 2 }).then(canvas => {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([new ClipboardItem({"image/png": blob})]).then(() => {
                        buttonFeedback(btn, "ğŸ–¼ï¸ è¤‡è£½åœ–ç‰‡");
                    });
                });
                title.style.display = 'none'; 
                footer.style.display = 'none'; 
                document.getElementById('page1').classList.remove('capturing');
            });
        };

        // --- ç¶²é äºŒ JS (æ¯æ—¥é‡‘é¡) ---
        let currentStats2 = null; let historyData2 = JSON.parse(localStorage.getItem('mealTracker_art_v2') || '[]');

        function handleCalculate2() {
            const raw = document.getElementById('orderInput2').value.trim(); if (!raw) return;
            const stats = { lunch: { '3F': 0, '1F': 0, total: 0 }, drink: { '3F': 0, '1F': 0, total: 0 } };
            let cat = '', floor = '';
            raw.split('\n').forEach(line => {
                const t = line.trim(); if (t.includes('åˆé¤')) cat = 'lunch'; else if (t.includes('é£²æ–™')) cat = 'drink';
                if (t.toUpperCase().includes('3F')) floor = '3F'; else if (t.toUpperCase().includes('1F')) floor = '1F';
                const match = t.match(/(\d+)\s*å…ƒ?\s*$/);
                if (match && cat && floor) { const v = parseInt(match[1]); stats[cat][floor] += v; stats[cat].total += v; }
            });
            currentStats2 = stats; renderUI2();
        }

        function renderUI2() {
            document.getElementById('resultArea2').classList.remove('hidden');
            const gen = (d, t) => d.total === 0 ? '' : `<div class="text-xs text-stone-400 mb-1 border-b pb-1">${t}</div>` + (d['3F']>0 ? `<div class="flex justify-between"><span>3F</span><span>${d['3F'].toLocaleString()}</span></div>` : '') + (d['1F']>0 ? `<div class="flex justify-between"><span>1F</span><span>${d['1F'].toLocaleString()}</span></div>` : '');
            document.getElementById('lunchResults2').innerHTML = gen(currentStats2.lunch, 'åˆé¤');
            document.getElementById('drinkResults2').innerHTML = gen(currentStats2.drink, 'é£²æ–™');
            const f1 = currentStats2.lunch['1F'] + currentStats2.drink['1F']; const f3 = currentStats2.lunch['3F'] + currentStats2.drink['3F'];
            document.getElementById('floor1Row2').classList.toggle('hidden', f1 === 0);
            document.getElementById('floor1TotalDisplay2').textContent = f1.toLocaleString();
            document.getElementById('floor3TotalDisplay2').textContent = f3.toLocaleString();
            document.getElementById('grandTotal2').textContent = (f1 + f3).toLocaleString();
        }

        function saveToHistory2() {
            if (!currentStats2) return; const total = currentStats2.lunch.total + currentStats2.drink.total;
            const date = new Date().toISOString().split('T')[0].replace(/-/g,'/');
            historyData2.push({ id: Date.now(), date, month: date.substring(0,7), amount: total });
            localStorage.setItem('mealTracker_art_v2', JSON.stringify(historyData2));
            updateMonthSelector2(); renderHistory2();
        }

        function updateMonthSelector2() {
            const months = [...new Set(historyData2.map(i => i.month))].sort().reverse();
            document.getElementById('monthFilter2').innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('') || '<option value="">ç„¡</option>';
        }

        function renderHistory2() {
            const m = document.getElementById('monthFilter2').value;
            const filtered = historyData2.filter(i => i.month === m).sort((a, b) => a.date.localeCompare(b.date));
            document.getElementById('monthTotalDisplay2').textContent = filtered.reduce((s,i)=>s+i.amount, 0).toLocaleString() + " å…ƒ";
            document.getElementById('historyList2').innerHTML = filtered.map(i => `
                <div class="journal-box p-3 flex justify-between items-center">
                    <span class="text-xs text-stone-400">${i.date}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-stone-400">$</span>
                        <input type="text" onchange="editAmount2(${i.id}, this.value)" value="${i.amount.toLocaleString()}" class="bg-transparent outline-none w-24 text-right" style="font-weight: normal;">
                        <button onclick="deleteRecord2(${i.id})" class="text-stone-300 hover:text-stone-500">âœ•</button>
                    </div>
                </div>`).join('');
        }

        function editAmount2(id, val) {
            const idx = historyData2.findIndex(i => i.id === id);
            if (idx > -1) {
                const numeric = parseInt(val.replace(/,/g, '')) || 0;
                historyData2[idx].amount = numeric;
                localStorage.setItem('mealTracker_art_v2', JSON.stringify(historyData2));
                renderHistory2();
            }
        }

        function deleteRecord2(id) {
            if (confirm("æ˜¯å¦ç§»é™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
                historyData2 = historyData2.filter(i => i.id !== id);
                localStorage.setItem('mealTracker_art_v2', JSON.stringify(historyData2));
                updateMonthSelector2(); renderHistory2();
            }
        }

        function handleCopy2() {
            if (!currentStats2) return;
            const b = (t, d) => d.total === 0 ? '' : `${t}\n` + (d['3F']>0?`3Fï¼š${d['3F']}\n`:'') + (d['1F']>0?`1Fï¼š${d['1F']}\n`:'');
            const txt = b("åˆé¤", currentStats2.lunch) + b("é£²æ–™", currentStats2.drink) + `\n3Fç¸½è¨ˆï¼š${currentStats2.lunch['3F'] + currentStats2.drink['3F']}\n\n$$æœˆçµ`;
            document.getElementById('hiddenCopyArea2').value = txt; document.getElementById('hiddenCopyArea2').select();
            document.execCommand('copy');
            buttonFeedback(document.getElementById('copyBtn2_real'), "è¤‡è£½çµæœ");
        }

        function handleClear2() { document.getElementById('orderInput2').value = ''; document.getElementById('resultArea2').classList.add('hidden'); }

        // --- ç¶²é ä¸‰ JS (çµ±è¨ˆåŠ©æ‰‹ - æ–‡é’å„ªåŒ–ç‰ˆ) ---
        let currentSummary = []; 
        let dragSrcIdx = null;
        let currentDropTargetIdx = null;
        let dropAction = null; 

        function showMessage(text) {
            const toast = document.getElementById('toast');
            toast.innerText = text;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        function processOrder() {
            const input = document.getElementById('inputData').value.trim();
            if (!input) return;

            const lines = input.split('\n');
            const summaryObj = {};
            const mode = document.querySelector('input[name="calcMode"]:checked').value;

            lines.forEach(line => {
                let trimmed = line.trim();
                if (!trimmed || !trimmed.includes('-')) return;
                if (trimmed.includes('=')) trimmed = trimmed.split('=')[0].trim();

                const parts = trimmed.split('-');
                const content = parts.slice(1).join('-').trim();
                const rawItems = (mode === 'combo') ? [content] : content.split('+');
                
                rawItems.forEach(rawItem => {
                    const subItem = rawItem.trim();
                    const match = subItem.match(/^(.*?)(\d+)\s*å…ƒ?$/);
                    if (match) {
                        let detail = match[1].trim(); 
                        const price = parseInt(match[2], 10);
                        detail = detail.replace(/([^\s])(ç„¡ç³–|å¾®ç³–|ä¸€åˆ†ç³–|äºŒåˆ†ç³–|ä¸‰åˆ†ç³–|åŠç³–|å°‘ç³–|ä¸ƒåˆ†ç³–|å»å†°|å¾®å†°|å°‘å†°|å¤šå†°|æ­£å¸¸|ç†±)/g, '$1 $2');
                        detail = detail.replace(/\s+/g, ' ').trim();
                        const key = `${detail}_${price}`;
                        if (!summaryObj[key]) {
                            summaryObj[key] = { name: detail, qty: 0, price: price, isMinor: false, checked: false };
                        }
                        summaryObj[key].qty += 1;
                    }
                });
            });

            currentSummary = Object.values(summaryObj);
            checkMinorItems(); 
            currentSummary.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            renderDisplay();
        }

        function checkMinorItems() {
            currentSummary.forEach(item => item.isMinor = false);
            const nameGroups = {};
            currentSummary.forEach(item => {
                const cleanName = item.name.replace(/\s+/g, ''); 
                if (!nameGroups[cleanName]) nameGroups[cleanName] = [];
                nameGroups[cleanName].push(item);
            });
            Object.keys(nameGroups).forEach(cleanName => {
                const group = nameGroups[cleanName];
                if (group.length > 1) {
                    group.sort((a, b) => (b.qty !== a.qty) ? (b.qty - a.qty) : (a.price - b.price));
                    for (let i = 1; i < group.length; i++) {
                        group[i].isMinor = true;
                    }
                }
            });
        }

        function renderDisplay() {
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = "";
            let totalQty = 0;
            let totalAmount = 0;

            currentSummary.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.draggable = true;
                tr.dataset.index = index;
                if (item.checked) tr.classList.add('row-checked');
                const starHtml = item.isMinor ? '<span class="star-mark">*</span>' : '';
                const checkIcon = item.checked ? 'â—' : 'â—‹';

                tr.innerHTML = `
                    <td class="check-cell" onclick="toggleCheck(${index}, event)">${checkIcon}</td>
                    <td>${item.name}${starHtml}</td>
                    <td>${item.qty}</td>
                `;
                
                tr.addEventListener('dragstart', handleDragStart);
                tr.addEventListener('dragover', handleDragOver);
                tr.addEventListener('dragleave', handleDragLeave);
                tr.addEventListener('drop', handleDrop);
                tr.addEventListener('dragend', handleDragEnd);

                tbody.appendChild(tr);
                totalQty += item.qty;
                totalAmount += (item.qty * item.price);
            });

            document.getElementById('totalQty').innerText = `${totalQty} ä»½`;
            document.getElementById('totalAmount').innerText = `$${totalAmount.toLocaleString()}`;
            document.getElementById('resultArea').style.display = 'block';
        }

        function toggleCheck(index, event) {
            event.stopPropagation();
            currentSummary[index].checked = !currentSummary[index].checked;
            renderDisplay();
        }

        function resetChecks() {
            if (currentSummary.length === 0) return;
            currentSummary.forEach(item => item.checked = false);
            renderDisplay();
            showMessage("å·²é‡è¨­å‹¾é¸ç‹€æ…‹");
        }

        function handleDragStart(e) {
            dragSrcIdx = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            const targetIdx = parseInt(this.dataset.index);
            if (dragSrcIdx === targetIdx) return false;
            const rect = this.getBoundingClientRect();
            const relY = e.clientY - rect.top;
            const height = rect.height;
            this.classList.remove('drop-before', 'drop-after', 'drop-merge');
            if (relY < height * 0.3) {
                this.classList.add('drop-before');
                dropAction = 'before';
            } else if (relY > height * 0.7) {
                this.classList.add('drop-after');
                dropAction = 'after';
            } else {
                this.classList.add('drop-merge');
                dropAction = 'merge';
            }
            currentDropTargetIdx = targetIdx;
            return false;
        }

        function handleDragLeave() {
            this.classList.remove('drop-before', 'drop-after', 'drop-merge');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            const targetIdx = currentDropTargetIdx;
            const srcIdx = dragSrcIdx;
            if (srcIdx === null || targetIdx === null || srcIdx === targetIdx) return;
            if (dropAction === 'merge') {
                triggerMerge(srcIdx, targetIdx);
            } else {
                const item = currentSummary.splice(srcIdx, 1)[0];
                let newTarget = targetIdx;
                if (dropAction === 'after' && srcIdx < targetIdx) newTarget = targetIdx;
                else if (dropAction === 'before' && srcIdx > targetIdx) newTarget = targetIdx;
                currentSummary.splice(newTarget, 0, item);
                renderDisplay();
            }
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('#resultTable tr').forEach(row => {
                row.classList.remove('drop-before', 'drop-after', 'drop-merge');
            });
        }

        function triggerMerge(srcIdx, targetIdx) {
            const src = currentSummary[srcIdx];
            const target = currentSummary[targetIdx];
            const modal = document.getElementById('mainModal');
            const modalMsg = document.getElementById('modalMsg');
            const priceArea = document.getElementById('priceInputArea');
            const priceInput = document.getElementById('customPrice');
            priceArea.style.display = 'none';
            if (src.price !== target.price) {
                modalMsg.innerHTML = `å–®åƒ¹ä¸åŒï¼Œåˆä½µå¾Œè¦ä½¿ç”¨å“ªå€‹é‡‘é¡ï¼Ÿ<br><span style="font-size:12px; color:#999;">${src.name} ($${src.price})<br>${target.name} ($${target.price})</span>`;
                priceArea.style.display = 'block';
                priceInput.value = target.price;
            } else {
                modalMsg.innerText = `ç¢ºèªåˆä½µã€Œ${src.name}ã€ï¼Ÿ`;
            }
            modal.style.display = 'flex';
            document.getElementById('modalYes').onclick = function() {
                if (src.price !== target.price) {
                    target.price = parseInt(priceInput.value) || target.price;
                }
                target.qty += src.qty;
                currentSummary.splice(srcIdx, 1);
                checkMinorItems(); 
                modal.style.display = 'none';
                renderDisplay();
                showMessage("å“é …å·²åˆä½µ");
            };
            document.getElementById('modalNo').onclick = function() { modal.style.display = 'none'; };
        }

        function copyResult() {
            if (currentSummary.length === 0) return;
            let copyText = "ã€ è¨‚å–®çµ±è¨ˆçµæœ ã€‘\n\n";
            currentSummary.forEach(item => {
                const starText = item.isMinor ? "*" : "";
                copyText += `Â· ${item.name}${starText} (x${item.qty})\n`;
            });
            copyText += `\nç¸½ä»½æ•¸ï¼š${document.getElementById('totalQty').innerText}\n`;
            copyText += `ç¸½é‡‘é¡ï¼š${document.getElementById('totalAmount').innerText}`;
            const el = document.createElement('textarea');
            el.value = copyText;
            document.body.appendChild(el); 
            el.select();
            try {
                document.execCommand('copy');
                showMessage("çµ±è¨ˆçµæœå·²æ”¶éŒ„è‡³å‰ªè²¼ç°¿");
            } catch (err) {
                showMessage("è¤‡è£½å¤±æ•—");
            }
            document.body.removeChild(el);
        }

        function clearContent() {
            document.getElementById('inputData').value = "";
            document.getElementById('resultArea').style.display = 'none';
            currentSummary = [];
        }
    </script>
</body>
</html>
