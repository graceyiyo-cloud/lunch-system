<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤é»çµ±è¨ˆç¶œåˆç®¡ç†ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        /* --- å…¨åŸŸå°è¦½æ¨£å¼ --- */
        .app-nav {
            background: #455A64;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .nav-btn {
            padding: 8px 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-btn.active {
            background: white;
            color: #455A64;
            font-weight: bold;
        }
        .page-container {
            display: none;
        }
        .page-container.active {
            display: block;
        }

        /* --- ç¶²é ä¸€ï¼šæœˆçµçµ±è¨ˆ CSS (åŸå§‹ä¿ç•™) --- */
        #page1 { font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif; background: #F2F0EB; padding: 20px; letter-spacing: 0.05em; }
        #page1 .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        #page1 h1 { text-align: center; color: #455A64; font-weight: normal; margin-bottom: 30px; }
        #page1 .control-panel { display: flex; gap: 20px; background: #E8E6E1; padding: 20px; border-radius: 8px; margin-bottom: 25px; align-items: center; color: #444; }
        #page1 .main-content { display: grid; grid-template-columns: 1.2fr 2fr; gap: 25px; }
        #page1 .section { border: 1px solid #EBEBEB; border-radius: 8px; padding: 20px; background: #fff; display: flex; flex-direction: column; margin-bottom: 25px; }
        #page1 h3 { border-bottom: 2px solid #F0F0F0; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #444; font-size: 1.1rem; font-weight: 600; }
        #page1 .scroll-area { overflow-y: auto; border: 1px solid #F5F5F5; border-radius: 4px; max-height: 400px; }
        #page1 table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #page1 th, #page1 td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #F0F0F0; }
        #page1 th { background-color: #E0E5DF; color: #333; position: sticky; top: 0; z-index: 10; font-weight: 700; }
        #page1 .excluded-header-row { background-color: #F7F7F7; color: #777; font-size: 13px; text-align: center; padding: 8px; }
        #page1 .excluded-row { background-color: #FCFCFC; color: #AAA; }
        #page1 .name-cell { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        #page1 .btn { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; color: white; font-size: 13px; display: none; }
        #page1 #copyBtn { background-color: #7A918D; }
        #page1 #copyImgBtn { background-color: #6B7C8A; }
        #page1 .price-input { width: 70px; text-align: right; border: 1px solid #DDD; border-radius: 4px; padding: 5px; color: #B05B5B; }
        #page1.capturing .price-input { display: none !important; }
        #page1.capturing .price-text { display: inline !important; font-weight: bold; color: #B05B5B; }

        /* --- ç¶²é äºŒï¼šæ¯æ—¥é‡‘é¡ CSS (åŸå§‹ä¿ç•™) --- */
        #page2 { background-color: #fdfbf7; font-family: 'Noto Sans TC', sans-serif; color: #57534e; padding: 20px; }
        #page2 .journal-box { background: #fff; border: 1px solid #e7e5e4; border-radius: 6px; }

        /* --- ç¶²é ä¸‰ï¼šæ˜ç´°åŠ©æ‰‹ CSS (åŸå§‹ä¿ç•™) --- */
        #page3 {
            --primary-color: #3498db; --primary-hover: #2980b9; --success-color: #27ae60; --success-hover: #219150;
            --danger-color: #e74c3c; --gray-color: #95a5a6; --gray-hover: #7f8c8d; --bg-color: #f4f7f9;
            --card-bg: #ffffff; --text-color: #2c3e50; --border-color: #e0e6ed; --hint-bg: #e7f3ff; --hint-border: #b3d7ff; --hint-text: #0056b3;
            background-color: var(--bg-color); color: var(--text-color); font-family: "Microsoft JhengHei", sans-serif; padding: 20px;
        }
        #page3 .container { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); max-width: 488px; margin: 0 auto; }
        #page3 h2 { text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.4rem; }
        #page3 .hint { background-color: var(--hint-bg); border: 1px solid var(--hint-border); color: var(--hint-text); font-size: 13px; padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; }
        #page3 .hint span { display: block; position: relative; padding-left: 18px; }
        #page3 .hint span::before { content: "â€¢"; position: absolute; left: 0; font-weight: bold; }
        #page3 textarea { width: 100%; height: 160px; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; resize: vertical; }
        #page3 .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        #page3 button { flex: 1; min-width: 100px; padding: 10px 5px; border-radius: 8px; font-size: 13px; font-weight: bold; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 4px; }
        #page3 .process-btn { background-color: var(--primary-color); color: white; }
        #page3 .copy-btn { background-color: var(--success-color); color: white; }
        #page3 .clear-btn { background-color: var(--gray-color); color: white; }
        #page3 #resultTable { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; font-size: 14px; }
        #page3 #resultTable th { background-color: #f8f9fa; padding: 10px 12px; border-bottom: 2px solid #eee; }
        #page3 #resultTable td { padding: 10px 12px; border-bottom: 1px solid #f1f1f1; cursor: grab; position: relative; }
        #page3 .check-cell { cursor: pointer; font-size: 22px; color: #cbd5e0; }
        #page3 .row-checked { color: var(--gray-color) !important; }
        #page3 .row-checked td:nth-child(2) { text-decoration: line-through; }
        #page3 .drop-merge { background-color: #fff3e0 !important; outline: 2px solid #ff9800; }
        #page3 .drop-before { border-top: 3px solid var(--primary-color) !important; }
        #page3 .drop-after { border-bottom: 3px solid var(--primary-color) !important; }
        #page3 .summary-box { background: #fdf9f2; border-left: 5px solid #f1c40f; padding: 15px; border-radius: 8px; }
        #page3 .total-price { color: var(--danger-color); font-size: 20px; }
        #page3 .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        #page3 .modal-content { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 300px; text-align: center; }
        #page3 .msg-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 50px; display: none; z-index: 3000; }
        #page3 .star-mark { color: var(--danger-color); font-weight: bold; margin-left: 4px; }
    </style>
</head>
<body>

    <nav class="app-nav">
        <button class="nav-btn active" onclick="switchPage(1)">1. æœˆçµçµ±è¨ˆ</button>
        <button class="nav-btn" onclick="switchPage(2)">2. æ¯æ—¥é‡‘é¡</button>
        <button class="nav-btn" onclick="switchPage(3)">3. æ˜ç´°åŠ©æ‰‹</button>
    </nav>

    <div id="page1" class="page-container active">
        <div class="container">
            <h1>æœˆçµé¤é»è²»ç”¨çµ±è¨ˆ</h1>
            <div class="control-panel">
                <div>1. ä¸Šå‚³æª”æ¡ˆï¼š<input type="file" id="fileInput" accept=".txt"></div>
                <div>2. é¸æ“‡æœˆä»½ï¼š<select id="monthSelect"></select></div>
                <div style="margin-left:auto;"><button onclick="clearAllData()" style="font-size: 11px; background: none; border: 1px solid #ccc; color: #999; cursor: pointer; border-radius: 4px; padding: 2px 8px;">æ‰‹å‹•æ¸…é™¤æ‰€æœ‰ç·©å­˜</button></div>
            </div>
            <div class="main-content">
                <div class="left-column">
                    <div class="section">
                        <h3><span>äººå“¡è²»ç”¨ç¸½è¨ˆ</span><span id="grandTotalDisplay" style="color: #5D4037;">0</span></h3>
                        <div class="scroll-area" id="summaryScrollArea">
                            <table id="summaryTable">
                                <thead><tr><th style="width:70%">å§“å</th><th style="width:30%">é‡‘é¡</th></tr></thead>
                                <tbody id="includedBody"></tbody>
                                <tbody><tr class="excluded-header-row"><td colspan="2">â–¼ æ’é™¤ä¸è¨ˆå€åŸŸ (ä¸åˆ—å…¥ç¸½é¡)</td></tr></tbody>
                                <tbody id="excludedBody" class="excluded-row"></tbody>
                            </table>
                        </div>
                        <div id="nonMonthlyList" class="non-monthly-box" style="display:none;"></div>
                    </div>
                    <div class="section">
                        <h3><span>æ¯æ—¥çµç®—ç¸½é¡</span><span id="dailyGrandTotalDisplay" style="color: #5D4037;">0</span></h3>
                        <div class="scroll-area"><table id="dailyTable"><thead><tr><th style="width:60%">æ—¥æœŸ</th><th style="width:40%">ç•¶æ—¥ç¸½é¡</th></tr></thead><tbody id="dailyBody"></tbody></table></div>
                    </div>
                </div>
                <div class="section" style="min-height: 600px;">
                    <h3><div>å€‹äººæ˜ç´°ï¼š<span id="selectedPersonName">-</span></div><div class="btn-group"><button id="copyBtn" class="btn">ğŸ“‹ è¤‡è£½æ–‡å­—</button><button id="copyImgBtn" class="btn">ğŸ–¼ï¸ è¤‡è£½åœ–ç‰‡</button></div></h3>
                    <div id="captureArea" style="background: white; padding: 15px; border-radius: 6px;">
                        <h4 id="imgTitle" style="margin: 0 0 15px 0; display:none; border-bottom: 2px solid #8FA39D; padding-bottom: 8px; font-size: 18px; color: #333;"></h4>
                        <div id="personalDetail"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="page2" class="page-container">
        <div class="max-w-md mx-auto py-10">
            <header class="mb-8 text-center"><h1 class="text-2xl font-normal tracking-[0.15em] text-stone-700 mb-3">ï¼æ¯æ—¥è¨‚é¤é‡‘é¡ç´€éŒ„ï¼</h1><div class="w-8 h-px bg-stone-300 mx-auto"></div></header>
            <div class="space-y-6">
                <section>
                    <label class="text-xs font-medium text-stone-400 mb-2 block">è¼¸å…¥è¨‚å–®å…§å®¹</label>
                    <textarea id="orderInput2" class="w-full h-44 p-4 journal-box outline-none resize-none text-sm text-stone-700 leading-relaxed" placeholder="è«‹åœ¨æ­¤è²¼ä¸Š..."></textarea>
                    <div class="flex gap-3 mt-3">
                        <button onclick="handleCalculate2()" class="flex-[2] bg-stone-600 text-white text-sm py-3 rounded shadow-sm">é–‹å§‹çµ±è¨ˆ</button>
                        <button onclick="handleClear2()" class="flex-1 border border-stone-300 text-stone-500 text-sm py-3 rounded hover:bg-stone-50">æ¸…ç©º</button>
                    </div>
                </section>
                <div id="resultArea2" class="hidden space-y-5">
                    <article class="journal-box p-6 relative bg-[#fffdfa]">
                        <div id="lunchResults2" class="space-y-2 text-base mb-5"></div>
                        <div id="drinkResults2" class="space-y-2 text-base"></div>
                        <div class="mt-6 pt-4 border-t border-dotted border-stone-300 space-y-2">
                            <div id="floor1Row2" class="hidden flex justify-between items-baseline text-stone-500"><span class="text-xs tracking-widest font-medium">1F åˆè¨ˆ</span><div class="text-lg font-light"><span id="floor1TotalDisplay2">0</span> å…ƒ</div></div>
                            <div class="flex justify-between items-baseline text-stone-500"><span class="text-xs tracking-widest font-medium">3F åˆè¨ˆ</span><div class="text-lg font-light"><span id="floor3TotalDisplay2">0</span> å…ƒ</div></div>
                            <div class="flex justify-between items-baseline pt-2 border-t border-stone-100"><span class="text-xs text-stone-400">ç¸½åˆè¨ˆ</span><div class="text-2xl font-light text-stone-800"><span id="grandTotal2">0</span> <span class="text-xs font-normal">å…ƒ</span></div></div>
                        </div>
                        <div class="flex gap-2 mt-5">
                            <button onclick="saveToHistory2()" class="flex-1 py-3 border border-stone-200 text-stone-600 text-xs rounded">è¨˜å…¥æ­·å²</button>
                            <button id="copyBtn2_real" onclick="handleCopy2()" class="flex-1 py-3 border border-stone-300 bg-stone-100 text-stone-600 text-xs rounded flex items-center justify-center gap-1">è¤‡è£½çµæœ</button>
                        </div>
                    </article>
                </div>
                <section class="pt-6 border-t border-stone-200">
                    <div class="flex justify-between items-end mb-4 px-1"><h3 class="text-xs font-medium text-stone-500">æ­·å²ç´€éŒ„</h3><select id="monthFilter2" onchange="renderHistory2()" class="bg-transparent text-xs text-stone-500 outline-none text-right"></select></div>
                    <div class="bg-stone-100 p-3 rounded mb-4 flex justify-between items-center border border-stone-200"><span class="text-xs text-stone-500">æœ¬æœˆç´¯è¨ˆ</span><span class="text-lg font-normal text-stone-700" id="monthTotalDisplay2">0 å…ƒ</span></div>
                    <div id="historyList2" class="space-y-2"></div>
                </section>
            </div>
        </div>
        <textarea id="hiddenCopyArea2" class="absolute -top-full opacity-0" readonly></textarea>
    </div>

    <div id="page3" class="page-container">
        <div id="toast3" class="msg-box"></div>
        <div id="mainModal3" class="modal">
            <div class="modal-content">
                <p id="modalMsg3" style="margin-top: 0;">è¨Šæ¯å…§å®¹</p>
                <div id="priceInputArea3" style="display: none;"><p style="font-size: 13px; color: #666;">è«‹ç¢ºèªæˆ–ä¿®æ”¹å–®åƒ¹ï¼š</p><input type="number" id="customPrice3" class="modal-input" style="width: 80%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; text-align: center; margin-bottom: 20px;"></div>
                <div class="modal-btns" style="display: flex; gap: 10px;"><button class="process-btn" id="modalYes3" style="flex:1; padding: 10px; background: #3498db; color: white; border-radius: 8px;">ç¢ºå®šåˆä½µ</button><button class="clear-btn" id="modalNo3" style="flex:1; padding: 10px; background: #95a5a6; color: white; border-radius: 8px;">å–æ¶ˆ</button></div>
            </div>
        </div>
        <div class="container">
            <h2>ğŸ± è¨‚å–®æ˜ç´°çµ±è¨ˆåŠ©æ‰‹ ğŸ±</h2>
            <div class="hint"><span>æ ¼å¼ï¼šå§“å-é¤é» åƒ¹æ ¼</span><span>ç›¸åŒåç¨±ä½†åƒ¹æ ¼ä¸åŒæ™‚æœƒæ¨™è¨» *</span><span><b>æ‹–æ‹‰</b>å“é …å¯é€²è¡Œ <b>åˆä½µ</b> æˆ– <b>æ’åº</b></span></div>
            <textarea id="inputData3" placeholder="è«‹è¼¸å…¥è¨‚å–®..."></textarea>
            <div class="btn-group">
                <button class="process-btn" onclick="processOrder3()">ğŸš€ é–‹å§‹çµ±è¨ˆ</button>
                <button class="copy-btn" onclick="copyResult3()">ğŸ“‹ è¤‡è£½çµæœ</button>
                <button class="clear-btn" onclick="clearContent3()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            <div id="resultArea3" style="display:none; margin-top: 20px;">
                <table id="resultTable"><thead><tr><th>âœ”</th><th>å“é …èˆ‡å‚™è¨»</th><th>æ•¸é‡</th></tr></thead><tbody id="resultBody3"></tbody></table>
                <div class="summary-box" style="margin-top:15px;"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>ç¸½ä»½æ•¸ï¼š</span><span id="totalQty3">0 ä»½</span></div><div style="display:flex; justify-content:space-between; font-weight:bold; font-size: 20px; color: #e74c3c;"><span>æ‡‰æ”¶ç¸½é‡‘é¡ï¼š</span><span id="totalAmount3">$0</span></div></div>
            </div>
        </div>
    </div>

    <script>
        // é€šç”¨åˆ‡æ›é‚è¼¯
        function switchPage(p) {
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('page'+p).classList.add('active');
            document.querySelectorAll('.nav-btn')[p-1].classList.add('active');
        }

        // --- ç¶²é ä¸€ JS (æœˆçµçµ±è¨ˆ) ---
        let rawFileText = ""; let forceIncludeDates = new Set(); let excludedUsers = new Set();
        let personalStats = {}; let dailyStats = {}; let nonMonthlyDates = []; let currentSelectedUser = null;

        window.onload = function() { loadFromLocalStorage(); updateMonthSelector2(); renderHistory2(); };

        function saveToLocalStorage() {
            const data = { rawFileText, forceIncludeDates: Array.from(forceIncludeDates), excludedUsers: Array.from(excludedUsers), lastSelectedMonth: document.getElementById('monthSelect').value };
            localStorage.setItem('lunchStatsData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('lunchStatsData');
            if (saved) {
                const data = JSON.parse(saved);
                rawFileText = data.rawFileText || "";
                forceIncludeDates = new Set(data.forceIncludeDates || []);
                excludedUsers = new Set(data.excludedUsers || []);
                if (rawFileText) { updateMonthDropdown(data.lastSelectedMonth); render(); }
            }
        }

        function clearAllData(silent = false) {
            if(silent || confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ä¸¦é‡è¨­ç¶²é å—ï¼Ÿ")) {
                localStorage.removeItem('lunchStatsData');
                location.reload();
            }
        }

        function updateMonthDropdown(preSelected) {
            const matches = rawFileText.match(/\d{4}\.\d{2}\.\d{2}/g);
            if(matches) {
                const months = [...new Set(matches.map(d => d.substring(0, 7)))].sort().reverse();
                const select = document.getElementById('monthSelect');
                select.innerHTML = months.map(m => `<option value="${m}">${m}æœˆ</option>`).join('');
                if (preSelected && months.includes(preSelected)) select.value = preSelected;
            }
        }

        function extractDayData(lines) {
            const dayData = {}; let mode = "meal";
            lines.forEach(line => {
                let t = line.trim();
                if (t === "---" || t.includes("é£²æ–™")) { mode = "drink"; return; }
                if (t === "åˆé¤") { mode = "meal"; return; }
                if (!t || t.includes("$$æœˆçµ") || t.includes("çµå–®")) return;
                const nameMatch = t.match(/^([^\d\s\-:ï¼š]{2,8})\s*[-:ï¼š]{1,2}(.*)$/);
                if (nameMatch) {
                    let name = nameMatch[1].trim().replace(/^\$/, ''); if (name === "å°è¨ˆ") return;
                    let content = nameMatch[2].trim();
                    if (!dayData[name]) dayData[name] = { total: 0, items: [], hasError: false };
                    let price = content.includes('=') ? parseInt(content.split('=').pop().match(/\d+/)) : parseInt(content.match(/\d+$/));
                    if (isNaN(price)) { dayData[name].hasError = true; dayData[name].items.push({ text: "âš ï¸ " + content, price: 0 }); }
                    else { dayData[name].total += price; dayData[name].items.push({ text: content, price: price }); }
                }
            });
            return dayData;
        }

        function parseLunchFile(text, targetMonth) {
            const lines = text.split(/\r?\n/); const result = {};
            const dateRegex = /^(\d{4}\.\d{2}\.\d{2})/; let datePositions = []; nonMonthlyDates = [];
            lines.forEach((line, idx) => { const m = line.match(dateRegex); if (m) datePositions.push({ idx, date: m[1].replace(/\./g, '-') }); });
            datePositions.forEach((pos, i) => {
                if (!pos.date.startsWith(targetMonth.replace('.','-'))) return;
                const nextIdx = datePositions[i+1] ? datePositions[i+1].idx : lines.length;
                const dayLines = lines.slice(pos.idx, nextIdx);
                if (dayLines.some(l => l.includes("$$æœˆçµ")) || forceIncludeDates.has(pos.date.replace(/-/g, '.'))) {
                    let lunchIdx = dayLines.findLastIndex(l => l.trim() === "åˆé¤");
                    if (lunchIdx !== -1) result[pos.date] = extractDayData(dayLines.slice(lunchIdx));
                } else nonMonthlyDates.push(pos.date.replace(/-/g, '.'));
            });
            return result;
        }

        document.getElementById('fileInput').addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = () => { rawFileText = reader.result; updateMonthDropdown(); render(); saveToLocalStorage(); };
            reader.readAsText(e.target.files[0]);
        });

        document.getElementById('monthSelect').addEventListener('change', () => { render(); saveToLocalStorage(); });

        function render() {
            const month = document.getElementById('monthSelect').value; if(!month) return;
            const data = parseLunchFile(rawFileText, month); personalStats = {}; dailyStats = {};
            for (let date in data) {
                if (!dailyStats[date]) dailyStats[date] = 0;
                for (let name in data[date]) {
                    if (!personalStats[name]) personalStats[name] = { total: 0, details: [], error: false };
                    personalStats[name].total += data[date][name].total; dailyStats[date] += data[date][name].total;
                    if (data[date][name].hasError) personalStats[name].error = true;
                    personalStats[name].details.push({ date, text: data[date][name].items.map(i=>i.text).join('ã€'), price: data[date][name].total });
                }
            }
            buildTable(); buildDailyTable(); renderNonMonthly();
        }

        function buildTable() {
            const inc = document.getElementById('includedBody'); const exc = document.getElementById('excludedBody');
            inc.innerHTML = ''; exc.innerHTML = ''; let grand = 0;
            Object.keys(personalStats).sort().forEach(name => {
                const isExc = excludedUsers.has(name); const stats = personalStats[name]; if (!isExc) grand += stats.total;
                const tr = document.createElement('tr'); if (isExc) tr.className = 'excluded-row';
                tr.innerHTML = `<td><div class="name-cell"><input type="checkbox" ${isExc?'':'checked'} onchange="toggleUser('${name}')"><span onclick="selectUser('${name}')">${name}${stats.error?'*':''}</span></div></td><td onclick="selectUser('${name}')" id="sum-${name}">${stats.total.toLocaleString()}</td>`;
                if (isExc) exc.appendChild(tr); else inc.appendChild(tr);
            });
            document.getElementById('grandTotalDisplay').textContent = grand.toLocaleString();
            document.getElementById('dailyGrandTotalDisplay').textContent = grand.toLocaleString();
        }

        function toggleUser(name) { if (excludedUsers.has(name)) excludedUsers.delete(name); else excludedUsers.add(name); buildTable(); saveToLocalStorage(); }
        function selectUser(name) { currentSelectedUser = name; updateDetail(name); }
        function buildDailyTable() {
            const body = document.getElementById('dailyBody'); body.innerHTML = '';
            Object.keys(dailyStats).sort().forEach(d => {
                body.innerHTML += `<tr><td>${d.replace(/-/g,'/')}</td><td id="daily-sum-${d}" style="font-weight:bold;">${dailyStats[d].toLocaleString()}</td></tr>`;
            });
        }

        function updateDetail(name) {
            const stats = personalStats[name]; document.getElementById('selectedPersonName').textContent = name;
            document.getElementById('copyBtn').style.display = document.getElementById('copyImgBtn').style.display = 'inline-block';
            const box = document.getElementById('personalDetail');
            box.innerHTML = stats.details.sort((a,b)=>a.date.localeCompare(b.date)).map((d,i) => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;">
                    <span style="font-size:14px;">${d.date.substring(5).replace('-','/')}ï¼š${d.text}</span>
                    <input type="number" class="price-input" value="${d.price}" oninput="handlePriceChange('${name}', ${i}, this.value, this)">
                    <span class="price-text" style="display:none;">${d.price}</span>
                </div>
            `).join('') + `<div style="text-align:right; font-weight:bold; margin-top:10px;">ç¸½è¨ˆï¼š<span id="detail-total-${name}">${stats.total.toLocaleString()}</span></div>`;
        }

        function handlePriceChange(name, idx, val, el) {
            val = parseInt(val) || 0; const old = personalStats[name].details[idx].price; const date = personalStats[name].details[idx].date;
            personalStats[name].details[idx].price = val; personalStats[name].total += (val - old);
            dailyStats[date] += (val - old); buildTable(); updateDetail(name);
        }

        function renderNonMonthly() {
            const el = document.getElementById('nonMonthlyList'); if (nonMonthlyDates.length > 0) {
                el.style.display = 'block'; el.innerHTML = `<strong>éæœˆçµæ—¥æœŸï¼š</strong><br>` + nonMonthlyDates.map(d => `<span onclick="forceIncludeDates.add('${d}');render();saveToLocalStorage();" style="cursor:pointer; text-decoration:underline; margin-right:8px;">${d}</span>`).join('');
            } else el.style.display = 'none';
        }

        document.getElementById('copyBtn').onclick = () => {
            const month = document.getElementById('monthSelect').value;
            let monthStr = month ? parseInt(month.split('-')[1]) : "XX";
            let txt = `${monthStr}æœˆçš„åˆé¤éŒ¢~Line payæˆ–æ˜¯åŒ¯æ¬¾éƒ½å¯å–”\n(ä¸è¦ipass money)\n\nâ†“åŒ¯æ¬¾å¸³è™Ÿâ†“\näº¬åŸéŠ€è¡Œ ç¸½è¡Œç‡Ÿæ¥­éƒ¨\n054\n001280705711`;
            navigator.clipboard.writeText(txt).then(() => { alert("å·²è¤‡è£½ï¼"); });
        };

        document.getElementById('copyImgBtn').onclick = () => {
            const area = document.getElementById('captureArea'); const title = document.getElementById('imgTitle');
            title.style.display = 'block'; title.textContent = `ã€${currentSelectedUser} é¤è²»æ˜ç´°ã€‘`;
            document.getElementById('page1').classList.add('capturing');
            html2canvas(area, { scale: 2 }).then(canvas => {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([new ClipboardItem({"image/png": blob})]).then(() => { alert("åœ–ç‰‡å·²è¤‡è£½ï¼"); });
                });
                title.style.display = 'none'; document.getElementById('page1').classList.remove('capturing');
            });
        };

        // --- ç¶²é äºŒ JS (æ¯æ—¥é‡‘é¡) ---
        let currentStats2 = null; let historyData2 = JSON.parse(localStorage.getItem('mealTracker_art_v2') || '[]');

        function handleCalculate2() {
            const raw = document.getElementById('orderInput2').value.trim(); if (!raw) return;
            const stats = { lunch: { '3F': 0, '1F': 0, total: 0 }, drink: { '3F': 0, '1F': 0, total: 0 } };
            let cat = '', floor = '';
            raw.split('\n').forEach(line => {
                const t = line.trim(); if (t.includes('åˆé¤')) cat = 'lunch'; else if (t.includes('é£²æ–™')) cat = 'drink';
                if (t.toUpperCase().includes('3F')) floor = '3F'; else if (t.toUpperCase().includes('1F')) floor = '1F';
                const match = t.match(/(\d+)\s*å…ƒ?\s*$/);
                if (match && cat && floor) { const v = parseInt(match[1]); stats[cat][floor] += v; stats[cat].total += v; }
            });
            currentStats2 = stats; renderUI2();
        }

        function renderUI2() {
            document.getElementById('resultArea2').classList.remove('hidden');
            const gen = (d, t) => d.total === 0 ? '' : `<div class="text-xs text-stone-400 mb-1 border-b pb-1">${t}</div>` + (d['3F']>0 ? `<div class="flex justify-between"><span>3F</span><span>${d['3F'].toLocaleString()}</span></div>` : '') + (d['1F']>0 ? `<div class="flex justify-between"><span>1F</span><span>${d['1F'].toLocaleString()}</span></div>` : '');
            document.getElementById('lunchResults2').innerHTML = gen(currentStats2.lunch, 'åˆé¤');
            document.getElementById('drinkResults2').innerHTML = gen(currentStats2.drink, 'é£²æ–™');
            const f1 = currentStats2.lunch['1F'] + currentStats2.drink['1F']; const f3 = currentStats2.lunch['3F'] + currentStats2.drink['3F'];
            document.getElementById('floor1Row2').classList.toggle('hidden', f1 === 0);
            document.getElementById('floor1TotalDisplay2').textContent = f1.toLocaleString();
            document.getElementById('floor3TotalDisplay2').textContent = f3.toLocaleString();
            document.getElementById('grandTotal2').textContent = (f1 + f3).toLocaleString();
        }

        function saveToHistory2() {
            if (!currentStats2) return; const total = currentStats2.lunch.total + currentStats2.drink.total;
            const date = new Date().toISOString().split('T')[0].replace(/-/g,'/');
            historyData2.push({ id: Date.now(), date, month: date.substring(0,7), amount: total });
            localStorage.setItem('mealTracker_art_v2', JSON.stringify(historyData2));
            updateMonthSelector2(); renderHistory2();
        }

        function updateMonthSelector2() {
            const months = [...new Set(historyData2.map(i => i.month))].sort().reverse();
            document.getElementById('monthFilter2').innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('') || '<option value="">ç„¡</option>';
        }

        function renderHistory2() {
            const m = document.getElementById('monthFilter2').value;
            const filtered = historyData2.filter(i => i.month === m);
            document.getElementById('monthTotalDisplay2').textContent = filtered.reduce((s,i)=>s+i.amount, 0).toLocaleString() + " å…ƒ";
            document.getElementById('historyList2').innerHTML = filtered.map(i => `
                <div class="journal-box p-3 flex justify-between">
                    <span class="text-xs text-stone-400">${i.date}</span>
                    <span class="font-bold">${i.amount.toLocaleString()}</span>
                </div>`).join('');
        }

        function handleCopy2() {
            if (!currentStats2) return;
            const b = (t, d) => d.total === 0 ? '' : `${t}\n` + (d['3F']>0?`3Fï¼š${d['3F']}\n`:'') + (d['1F']>0?`1Fï¼š${d['1F']}\n`:'');
            const txt = b("åˆé¤", currentStats2.lunch) + b("é£²æ–™", currentStats2.drink) + `\n3Fç¸½è¨ˆï¼š${currentStats2.lunch['3F'] + currentStats2.drink['3F']}\n\n$$æœˆçµ`;
            document.getElementById('hiddenCopyArea2').value = txt; document.getElementById('hiddenCopyArea2').select();
            document.execCommand('copy'); alert("è¤‡è£½æˆåŠŸ");
        }

        function handleClear2() { document.getElementById('orderInput2').value = ''; document.getElementById('resultArea2').classList.add('hidden'); }

        // --- ç¶²é ä¸‰ JS (æ˜ç´°åŠ©æ‰‹) ---
        let currentSummary3 = []; let dragSrcIdx3 = null;

        function processOrder3() {
            const raw = document.getElementById('inputData3').value.trim(); if (!raw) return;
            const obj = {};
            raw.split('\n').forEach(line => {
                const parts = line.split('-'); if (parts.length < 2) return;
                const match = parts[1].match(/^(.*?)(\d+)\s*å…ƒ?$/);
                if (match) {
                    const name = match[1].trim(), price = parseInt(match[2]), key = `${name}_${price}`;
                    if (!obj[key]) obj[key] = { name, price, qty: 0, checked: false };
                    obj[key].qty++;
                }
            });
            currentSummary3 = Object.values(obj); renderDisplay3();
        }

        function renderDisplay3() {
            const body = document.getElementById('resultBody3'); body.innerHTML = '';
            let tq = 0, ta = 0;
            currentSummary3.forEach((item, idx) => {
                const tr = document.createElement('tr'); tr.draggable = true;
                if (item.checked) tr.classList.add('row-checked');
                tr.innerHTML = `<td class="check-cell" onclick="currentSummary3[${idx}].checked=!currentSummary3[${idx}].checked;renderDisplay3();">${item.checked?'â˜‘':'â˜'}</td><td>${item.name}</td><td>${item.qty}</td>`;
                tr.addEventListener('dragstart', () => { dragSrcIdx3 = idx; });
                tr.addEventListener('dragover', e => {
                    e.preventDefault(); const rect = tr.getBoundingClientRect();
                    const rel = e.clientY - rect.top;
                    tr.classList.remove('drop-before', 'drop-after', 'drop-merge');
                    if (rel < rect.height * 0.3) tr.classList.add('drop-before');
                    else if (rel > rect.height * 0.7) tr.classList.add('drop-after');
                    else tr.classList.add('drop-merge');
                });
                tr.addEventListener('drop', () => {
                    const src = currentSummary3[dragSrcIdx3];
                    const target = currentSummary3[idx];
                    const modal = document.getElementById('mainModal3');
                    if (document.querySelector('.drop-merge')) {
                        document.getElementById('modalMsg3').textContent = `å°‡ã€Œ${src.name}ã€åˆä½µè‡³ã€Œ${target.name}ã€ï¼Ÿ`;
                        modal.style.display = 'flex';
                        document.getElementById('modalYes3').onclick = () => {
                            target.qty += src.qty; currentSummary3.splice(dragSrcIdx3, 1);
                            modal.style.display = 'none'; renderDisplay3();
                        };
                        document.getElementById('modalNo3').onclick = () => modal.style.display = 'none';
                    } else {
                        currentSummary3.splice(dragSrcIdx3, 1);
                        currentSummary3.splice(idx, 0, src); renderDisplay3();
                    }
                });
                body.appendChild(tr); tq += item.qty; ta += (item.qty * item.price);
            });
            document.getElementById('totalQty3').textContent = tq + " ä»½";
            document.getElementById('totalAmount3').textContent = "$" + ta.toLocaleString();
            document.getElementById('resultArea3').style.display = 'block';
        }

        function copyResult3() {
            const txt = "ã€è¨‚å–®çµæœã€‘\n" + currentSummary3.map(i => `${i.name} * ${i.qty}`).join('\n');
            navigator.clipboard.writeText(txt).then(() => alert("çµæœå·²è¤‡è£½ï¼"));
        }
        function clearContent3() { document.getElementById('inputData3').value = ''; document.getElementById('resultArea3').style.display = 'none'; }
    </script>
</body>
</html>
